<!DOCTYPE html>
<html lang="en">
  <head>
  
  </head>

  <body>

    <br><h1>message input</h1>
    <input type="text" id="messageInput" />
    <button id="sendButton">Send Message</button>
    <br><br>

    <h1>MESSAGES BELOW</h1>
    <ul id="messagesList"></ul>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script type="text/javascript">

class APIConnection {
  constructor() {
    this.URL = "http://ec2-18-189-105-20.us-east-2.compute.amazonaws.com/api/";
    this.token = "";
    this.refresh = "";
    this.email = "";
    this.data = {};
    this.chatConnection = new signalR.HubConnectionBuilder()
      .withUrl("/chat", { accessTokenFactory: () => this.token })
      .build();
  }

  async getOneTimeCode(password) {
    const res = await fetch(this.URL + "auth/login", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "*/*",
      },
      body: `{
        "email": "${this.email}",
        "password": ${password}
      }`,
    });
  }

  async verifyOneTimeCode(code) {
    let response = await fetch(this.URL + `auth/${this.email}/${code}`, {
      method: "POST",
      headers: {
        Accept: "*/*",
      },
    });

    let data = await response.json();
    this.token = data.accessToken;
    this.refresh = data.refreshToken;
  }

  async getPatientData(property) {
    let path = this.URL + "patient";
    if (property !== undefined) {
      path += `/${property}`;
    }
    let response = await fetch(path, {
      method: "GET",
      headers: {
        Accept: "*/*",
        Authorization: `Bearer ${this.token}`,
      },
    });

    let dataObject = await response.json();
    if (property === undefined) {
      this.data = dataObject;
    } else {
      this.data[property] = dataObject[property];
    }
    return dataObject;
  }

  async postPatientData(dataObject) {
    let response = await fetch(this.URL + "patient", {
      method: "POST",
      headers: {
        Accept: "*/*",
        "Content-Type": "application/json-patch+json",
        Authorization: `Bearer ${this.token}`,
      },
      body: JSON.stringify(dataObject),
    });
  }

  async getModelResponse(input) {
    if (this.chatConnection.state !== "Connected") {
      await this.chatConnection.start();
    }
    return this.chatConnection.invoke("SendMessage", input);
  }

  async refreshTokens() {
    let response = await fetch(this.URL + `auth/refresh-tokens`, {
      method: "POST",
      headers: {
        Accept: "*/*",
      },
      body: this.refresh
    });

    let data = await response.json();
    this.token = data.accessToken;
    this.refresh = data.refreshToken;
  }
}

//Usage:
user = new APIConnection();
//the constructor should check localStorage to populate as much data as possible.
//relevant data is:
//user's refresh token
//user's email

user.email = "ryanbhillis@gmail.com";
user.getOneTimeCode("stringSTRING123!@#"); //logs-in and gets OTC to email
//NOTICE: WE DO NOT WANT TO STORE THE USER'S PASSWORD

let oneTimeCode = prompt("Type the One-Time Code")

user.verifyOneTimeCode(oneTimeCode); //this will get the tokens and authenticate the user
//the refreshToken should be saved to localStorage

user.getPatientData(); //returns JSON result
//the result is also stored in the user data object
console.log(user.data);

//more examples
user.getPatientData("property")
user.postPatientData({
   property: value,
   anotherProperty, anotherValue
});

//to talk to the LLM
user.getModelResponse("text input goes here")//web sockets are handled under the hood

//to handle the LLM response
user.chatConnection.on("ReceiveMessage", message => {
  alert(message)
})

//after 10 minutes, the access token will expire and we will have to request another one
user.refreshTokens()


//example implementation:
function startPage() {
   // Send message to the hub
   document.getElementById("sendButton").addEventListener("click", function () {
          const message = document.getElementById("messageInput").value;
          user.getModelResponse(message)
      });
  
      // Receive messages from the hub
      user.chatConnection.on("ReceiveMessage", function (message) {
          const li = document.createElement("li");
          li.textContent = `${message}`;
          document.getElementById("messagesList").appendChild(li);
      });
}

//you need to implement:
//getting accessTokens by calling user.refreshTokens()
//    either do it on a timer or detect when the tokens expire and then refresh

//saving data to localstorage
//    most importantly!!!! save user.refresh
//    but also maybe email, data, idk

//initializing from localstorage
//    when we call new APIConnection()
//    populate data from localstorage
//    if there is a valid refreshToken then use .refreshTokens() to get an accessToken
//    maybe also open the websocket for the chat using .chatConnection.start()
  </script>
  </body>
</html>